# 为什么不再使用sleuth

sleuth目前也进入了维护模式，官方推荐 [Micrometer Tracing](https://micrometer.io/) 

![image-20240401133942895](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011741481.png)

springboot3.x版本无法再使用sleuth

![image-20240401140825924](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011741508.png)

Micrometer链路追踪不仅可以帮助开发人员快速定位和排查系统中的问题，还可以用于分析系统请求链路中的性能问题。通过收集各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等信息，开发人员可以深入了解系统的运行状况，优化性能并提升用户体验。

![image-20240401160535438](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011741619.png)

# 分布式链路追踪简介

在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的的服务节点调用来协同产生最后的请求结果，每一个前段请求都会形成一条复杂的分布式服务调用链路，链路中的任何一环出现高延时或错误都会引起整个请求最后的失败。

![img](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011741523.png)



在分布式与微服务场景下，我们需要解决如下问题：

在大规模分布式与微服务集群下，如何实时观测系统的整体调用链路情况。

在大规模分布式与微服务集群下，如何快速发现并定位到问题。

在大规模分布式与微服务集群下，如何尽可能精确的判断故障对系统的影响范围与影响程度。

在大规模分布式与微服务集群下，如何尽可能精确的梳理出服务之间的依赖关系，并判断出服务之间的依赖关系是否合理。

在大规模分布式与微服务集群下，如何尽可能精确的分析整个系统调用链路的性能与瓶颈点。

在大规模分布式与微服务集群下，如何尽可能精确的分析系统的存储瓶颈与容量规划。

 

分布式链路追踪（Distributed Tracing）是**一种监控和诊断复杂分布式系统性能的技术**，就是将一次分布式请求还原成调用链路，进行日志记录，性能监控并将一次分布式请求的调用情况集中展示。比如各个服务节点上的耗时、请求具体到达哪台机器上、每个服务节点的请求状态等等。





## OpenTracing是什么？

随着微服务架构的普及,类似skywalking这种分布式追踪系统(分布式链路追踪最先有Google在Dapper论文中提出)大量涌现,但API互不兼容,难以整合和切换,因此提l出了统一的平台无关、厂商无关的API，不同的分布式追踪系统去实现。OpenTracing调用链跟踪系统的一个事实标准，它制定了调用链跟踪的基本流程和基本的数据结构,同时也提供了各个语言的实现。

1）基本概念：
● Trace：一个事务或者流程在（分布式）系统中的执行过程，可以认为是多个span的有向无环图（DAG）。

● Span：一个span代表系统中具有开始时间和执行时长的逻辑运行单元。span之间通过嵌套或者顺序排列建立逻辑因果关系。

● Logs：每个span可以进行多次Logs操作，每一次Logs操作，都需要一个带时间戳的时间名称，以及可选的任意大小的存储结构。

● Tags：每个span可以有多个键值对（key:value）形式的Tags，Tags是没有时间戳的，支持简单的对span进行注解和补充。

● SpanContext：SpanContext代表跨越进程边界，传递到下级span的状态。(例如，包含<trace_id, span_id, sampled>元组)，并用于封装Baggage。

● References：一个span可以和一个或者多个span间存在因果关系。OpenTracing定义了两种关系：ChildOf 和 FollowsFrom。这两种引用类型代表了子节点和父节点间的直接因果关系。

● Baggage：是存储在SpanContext中的一个键值对(SpanContext)集合。它会在一条追踪链路上的所有span内全局传输，包含这些span对应的SpanContexts。

![image-20240401153556872](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011741510.png)

1.在一个分布式系统中，追踪一个事务或者调用流一般如下图所示。虽然这种图对于看清各组件的组合关系是很有用的，但是，它不能很好显示组件的调用时间，是串行调用还是并行调用，如果展现更复杂的调用关系，会更加复杂，甚至无法画出这样的图。另外，这种图也无法显示调用间的时间间隔以及是否通过定时调用来启动调用。

![image-20240401153613128](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011742119.png)

2.下面这种展现方式增加显示了执行时间的上下文，相关服务间的层次关系，进程或者任务的串行或并行调用关系。这样的视图有助于发现系统调用的关键路径。通过关注关键路径的执行过程，项目团队可能专注于优化路径中的关键位置，最大幅度的提升系统性能。例如：可以通过追踪一个资源定位的调用情况，明确底层的调用情况，发现哪些操作有阻塞的情况。



![image-20240401153646077](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011742354.png)

## 原理

假定3个微服务调用的链路：Service1调用Service2.Service2调用Service3和Service4

![image-20240401154012774](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011742387.png)

那么一条链路追踪会在每个服务调用的时候加上Trace ID 和 Span ID

一条链路通过Trace Id唯一标识，Span标识发起的请求信息

![image-20240401154308119](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011742589.png)

Client Sent：客户端发送这个请求的时间。

Server Received：服务端接收到这个请求的时间。

Client Received: 客户端接收到数据的时间。

Server Sent： 服务端发送响应的时间。





各span通过parent id 关联起来

![image-20240401154332676](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404011742804.png)





| 1    | 第一个节点：Span ID = A，Parent ID = null，Service 1 接收到请求。 |
| ---- | ------------------------------------------------------------ |
| 2    | 第二个节点：Span ID = B，Parent ID= A，Service 1 发送请求到 Service 2 返回响应给Service 1 的过程。 |
| 3    | 第三个节点：Span ID = C，Parent ID= B，Service 2 的 中间解决过程。 |
| 4    | 第四个节点：Span ID = D，Parent ID= C，Service 2 发送请求到 Service 3 返回响应给Service 2 的过程。 |
| 5    | 第五个节点：Span ID = E，Parent ID= D，Service 3 的中间解决过程。 |
| 6    | 第六个节点：Span ID = F，Parent ID= C，Service 3 发送请求到 Service 4 返回响应给 Service 3 的过程。 |
| 7    | 第七个节点：Span ID = G，Parent ID= F，Service 4 的中间解决过程。 |
| 8    | 通过 Parent ID 就可找到父节点，整个链路即可以进行跟踪追溯了。 |



## 行业内比较成熟的分布式链路追踪技术解决方案

如Twitter的Zipkin，Uber的Jaeger，pinpoint，Apache开源的skywalking，还有国产如阿里的鹰眼，美团的Mtrace，滴滴Trace，新浪的Watchman，京东的Hydra，不过国内的这些基本都没有开源。

为了便于各系统间能彼此兼容互通，OpenTracing组织制定了一系列标准，旨在让各系统提供统一的接口。

- Zipkin：Zipkin是Twitter开源的一款分布式链路追踪系统，用于收集服务的时序数据，以提供分布式追踪系统延迟数据的可视化。通过Zipkin，可以追踪请求在分布式系统中的传递路径和相关的上下文信息，帮助开发人员快速定位和排查系统中的问题。




- SkyWalking：SkyWalking是Apache软件基金会下的一个开源项目，是一个应用性能监控系统（APM），专门为微服务、云原生和基于容器（Docker、K8s、Mesos）架构的系统设计。SkyWalking提供分布式追踪、服务网格遥测分析、度量聚合和可视化一体化解决方案。


- CAT：CAT 是由大众点评开源的项目，它的版本相对来说古老一些，但是也有自己的优点，如它的报表功能比较完全，是基于 Java 开发的实时应用监控平台，包括实时应用监控、业务监控，可以提供十几张报表展示。一个很大的缺点是它的代码有侵入性，即使用 CAT 必须进行代码的更改。对一些框架的使用进行白点，白点处理后才能进行数据的报告。




- PinPoint：Pinpoint 是由韩国进行开发的，最大的优点是对代码的无侵入性，即不修改代码，使用 PinPoint 来监控系统，同时 PinPoint 的UI 页面的元素非常丰富，用户体验很好。但是 PinPoint 有一个比较大的缺点，它收集了很多的数据导致整体的性能比较差。




- Sleuth：**Spring Cloud Sleuth**是一个分布式跟踪系统，主要用于在微服务架构中追踪请求的流程和跨服务调用的链路。它通过将跟踪信息关联到请求的链路中，使得开发人员能够跟踪请求在不同服务之间的传递，并识别可能的性能问题或故障。


由于Spring Cloud Sleuth最新版本只支持Spring Boot 2.7.x，核心项目已经迁移到Micrometer Tracing项目。因此，在Spring Boot 3.x版本中实现分布式链路追踪需要集成Micrometer。这使得基于Spring Cloud的微服务架构能够轻松地使用Micrometer进行链路追踪。

