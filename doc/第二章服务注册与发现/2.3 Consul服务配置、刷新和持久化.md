微服务单体应用中的业务拆分成一个个子服务，每个服务的粒度相对较小，因此系统中会出现大量的服务。由于每个服务都需要必要的配置信息才能运行，所以一套集中式的、动态的配置管理设施是必不可少的。比如某些配置文件中的内容大部分都是相同的，只有个别的配置项不同。就拿数据库配置来说吧，如果每个微服务使用的技术栈都是相同的，则每个微服务中关于数据库的配置几乎都是相同的，有时候主机迁移了，我希望一次修改，处处生效。

# 服务配置

通用全局配置信息，直接注册进Consul服务器，从Consul获取

## cloud-provider-payment8001

### pom添加依赖

```xml
<!--SpringCloud consul config-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-config</artifactId>
</dependency>
```



也可以直接用 spring-cloud-starter-consul-all, 包含了 spring-cloud-starter-consul-discovery 和 spring-cloud-starter-consul-config

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-all</artifactId>
</dependency>
```

### 配置规则说明

![image-20240329092140964](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559868.png)

针对第一点说明

1. Spring Boot 2.3.x 及之前版本：
   - 如果你使用的是Spring Boot 2.3.x或更早的版本，并且想要利用`bootstrap.yml`来在应用程序上下文创建之前加载配置（例如，从Consul加载配置），则你通常需要设置`spring.cloud.bootstrap.enabled=true`或在项目中包含`spring-cloud-starter-bootstrap`依赖。
2. Spring Boot 2.4.x 及之后版本：
   - 从Spring Boot 2.4开始，配置加载机制发生了变化，`bootstrap.yml`的特殊性被移除了。默认情况下，Spring Boot会加载`application.yml`（或`application.properties`）和`bootstrap.yml`（如果存在的话），但`bootstrap.yml`不再具有优先加载的特权。

从 Spring Boot 2.4 开始，官方就推荐使用 `application.yml` 或 `application.properties` 来配置外部属性，而不再需要单独的 `bootstrap` 阶段。

因此不需要（也不应该）创建 `bootstrap.yml` 文件来配置 Consul。相反，你应该直接在 `application.yml` 文件中配置你的 Consul 设置。

针对第二点说明

我们Consul中配置的yaml文件必须定义在任意指定的目录下,如：

config/cloud-payment-service/data

config/cloud-payment-service-dev/data

config/cloud-payment-service-prod/data

### yml

基于bootstrap.yml加载配置的方法就不做赘述了，现在使用application.yml加载配置



![image-20240329110845406](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559190.png)

新增

```yaml
spring:
  config:
    import: 'optional:consul:'  #关键点 导入外部配置源，读取Consul中的配置
  profiles:
    active: dev #多环境配置 如dev/test/prod，默认为default
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      config:
        enabled: true
        profile-separator: '-'    #文件分隔符，默认使用','  根据我们定义文件名的习惯(如application-dev.yml)修改为'-'
        format: YAML
```



完整配置：

```yaml
server:
  port: 8001

# ==========applicationName + druid-mysql8 driver===================
spring:
  application:
    name: cloud-payment-service
  config:
    import: 'optional:consul:'  #关键点 导入外部配置源，读取Consul中的配置
  profiles:
    active: dev #多环境配置 如dev/test/prod，默认为default
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://localhost:3306/springcloud2024?characterEncoding=utf8&useSSL=false&serverTimezone=GMT%2B8&rewriteBatchedStatements=true&allowPublicKeyRetrieval=true
    username: root
    password: root
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
      config:
        enabled: true
        profile-separator: '-'    #文件分隔符，默认使用','  根据我们定义文件名的习惯(如application-dev.yml)修改为'-'
        format: YAML
  # ========================日期格式化=====================
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT-8
# ========================mybatis===================
mybatis:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.dongguo.cloud.entity
  configuration:
    map-underscore-to-camel-case: true


# ========================swagger=====================
springdoc:
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
```



### Consul的key/value配置

1.创建config文件夹，以/结尾

![image-20240329094402905](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559365.png)

To create a folder, end a key with `/`   创建文件加以/结尾

2.config文件夹下分别创建其它3个文件夹，以/结尾

![image-20240329094610283](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559563.png)

3.创建data文件，选择yaml格式，输入测试数据

注意空格不要使用tab键

![image-20240329101429488](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559647.png)



### 测试

PayController读取consul配置测试

```java
    @Value("${server.port}")
    private String port;
    @Value("${active.info}")
    private String info;
    @GetMapping(value = "/get/info")
    private Result getInfoByConsul() {
        return Result.success("info: " + info + "," + "port: " + port);
    }
```

访问http://localhost:8001/pay/get/info

![image-20240329144922976](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559567.png)

# 动态刷新

如果在Consul配置中心修改了配置信息，微服务是不能及时更新的，需要在主启动类上添加注解`@RefreshScope`

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@MapperScan("com.dongguo.cloud.mapper") //import tk.mybatis.spring.annotation.MapperScan;
@EnableDiscoveryClient
@RefreshScope
public class Payment8001Application {

    public static void main(String[] args) {
       SpringApplication.run(Payment8001Application.class, args);
       System.out.println("http://127.0.0.1:8001/swagger-ui.html");
    }
}
```

## 测试

修改consul中的配置

![image-20240329112318091](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559499.png)

控制台打印出active.info改变，进行了刷新

![image-20240329112339760](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404022035544.png)





## 配置自动更新, Config Watch

`@RefreshScope`与Consul之间的动态刷新是通过Spring Cloud内部的配置监听和通知机制相结合来实现的，

Consul Config Watch 使用 consul 的路径前缀对配置更新进行检查, 当配置变化时会产生一个 Refresh Event, 等价于请求 /refresh actuator endpoint.

默认的检查频率为 1000 单位毫秒, 可以通过 spring.cloud.consul.config.watch.delay 配置

如果要禁用配置自动更新, 需要设置 spring.cloud.consul.config.watch.enabled=false


```yaml
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
      config:
        enabled: true
        profile-separator: '-'    #文件分隔符，默认使用','  根据我们定义文件名的习惯(如application-dev.yml)修改为'-'
        format: YAML
        watch:
          enabled: false
```

禁用配置自动更新，即使主启动添加了@RefreshScope，Consul配置发生了改变，微服务也无法得知。

# Consul数据持久化

如果Consul应用重启了，配置中心的数据会丢失，服务就获取不到之前的数据，刷新Consul页面会报404错误，如下图：

![image-20240329113128197](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559048.png)

## 持久化配置

可以本地文件保存方式实现数据持久化，在consul安装目录下，新建consul_data文件夹和consul_start.bat文件，在consul_start.bat文件中填写如下内容：

```bat
@echo.Consul服务正在启动......
@echo off
@sc create Consul binpath="E:\software\consul\consul_1.18.1\consul.exe agent -server -ui -bind=127.0.0.1 -client=0.0.0.0 -bootstrap-expect 1 -data-dir E:\software\consul\consul_1.18.1\consul_data"
@net start Consul
@sc config Consul start=AUTO
@echo.Consul start is OK ...... Success
@pause
```

使用管理员权限运行consul_start.bat

![image-20240329113731673](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559819.png)

重新创建config/cloud-payment-service-dev/data文件配置consul

![image-20240329114024356](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291559077.png)

cmd控制台输入任意键退出后重新使用管理员权限运行consul_start.bat

刷新consul页面配置依然存在。

![image-20240329114311762](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291558343.png)

可以看到consul_data文件夹中生成了一些文件保存consul的快照

![image-20240329114408648](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291558229.png)