# 支付服务provider8001注册进consul

## pom添加consul依赖

```xml
<!--SpringCloud consul discovery -->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-consul-discovery</artifactId>
</dependency>
```

## application.yml添加consul配置

```yaml
####Spring Cloud Consul for Service Discovery
spring:
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        service-name: ${spring.application.name}
```

## 主启动@EnableDiscoveryClient启用服务发现功能

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import tk.mybatis.spring.annotation.MapperScan;

@SpringBootApplication
@MapperScan("com.dongguo.cloud.mapper") //import tk.mybatis.spring.annotation.MapperScan;
@EnableDiscoveryClient
public class Payment8001Application {

	public static void main(String[] args) {
		SpringApplication.run(Payment8001Application.class, args);
		System.out.println("http://127.0.0.1:8001/swagger-ui.html");
	}
}
```

## 启动8001并查看consul控制台

![image-20240328200716872](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403282105798.png)

# 订单服务consumer80注册进consul

与provider8001同

## pom添加consul依赖

```xml
        <!--SpringCloud consul discovery -->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>
```

## application.yml添加consul配置

```yaml
  ####Spring Cloud Consul for Service Discovery
spring:  
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #优先使用服务ip进行注册
        service-name: ${spring.application.name}
```

## 主启动@EnableDiscoveryClient启用服务发现功能

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Order80Application {

    public static void main(String[] args) {
        SpringApplication.run(Order80Application.class, args);
        System.out.println("http://127.0.0.1:80/swagger-ui.html");
    }
}
```

## 业务类

OrderController：

```java
//    public static final String PAYMENT_SERVICE_URL = "http://localhost:8001";//先写死，硬编码
    public static final String PAYMENT_SERVICE_URL = "http://cloud-payment-service";//服务注册中心上的微服务名称
```

## 启动80并查看consul控制台

![image-20240328201547335](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403282105421.png)

# 访问测试

![image-20240328201640475](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403282105893.png)

80后端报错Caused by: java.net.UnknownHostException: Failed to resolve 'cloud-payment-service' [A(1), AAAA(28)] after 3 queries 

在stackoverflow找到解决方案：

https://stackoverflow.com/questions/72569019/java-net-unknownhostexception-failed-to-resolve-inventory-service-after-4-que/77677939

![image-20240328210126116](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403282105038.png)

## 修改WebClientConfig

```java
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
public class WebClientConfig {

//    @Bean
//    @LoadBalanced
//    public WebClient webClient(){
//        return WebClient.builder().build();
//    }

    @Bean
    @LoadBalanced
    public WebClient.Builder loadBalancedWebClientBuilder() {
        return WebClient.builder();
    }
}
```

## controller

```java
import com.dongguo.cloud.entity.DTO.PayDTO;
import com.dongguo.cloud.resp.Result;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.reactive.function.client.WebClient;


@RestController
@RequestMapping("/consumer/pay")
@Tag(name = "订单模块", description = "订单控制器接口")
public class OrderController {
//    public static final String PAYMENT_SERVICE_URL = "http://localhost:8001";//先写死，硬编码
    public static final String PAYMENT_SERVICE_URL = "http://cloud-payment-service";//服务注册中心上的微服务名称
//    @Autowired
//    private WebClient webClient;
    @Autowired
    private WebClient.Builder webClientBuilder;

    /**
     * 一般情况下，通过浏览器的地址栏输入url，发送的只能是get请求
     * 我们底层调用的是post方法，模拟消费者发送get请求，客户端消费者
     * 参数可以不添加@RequestBody
     *
     * @param payDTO
     * @return
     */
    @PostMapping("/add")
    @Operation(summary = "新增", description = "新增支付流水,json串做参数")
    public Result addOrder(@RequestBody PayDTO payDTO) {
        String url = PAYMENT_SERVICE_URL + "/pay/add";
        return webClientBuilder.build().post().uri(url).contentType(MediaType.APPLICATION_JSON).bodyValue(payDTO).retrieve().bodyToMono(Result.class).block();
    }

    @GetMapping("/get/{id}")
    @Operation(summary = "按照ID查流水", description = "查询支付流水")
    public Result getPayInfo(@PathVariable("id") Integer id) {
        String url = PAYMENT_SERVICE_URL + "/pay/get/" + id;
        return webClientBuilder.build().get().uri(url).retrieve().bodyToMono(Result.class).block();
    }

    @GetMapping(value = "/del/{id}")
    @Operation(summary = "删除", description = "删除支付流水")
    public Result deletePay(@PathVariable("id") Integer id) {
        String url = PAYMENT_SERVICE_URL + "/pay/del/" + id;
        return webClientBuilder.build().delete().uri(url).retrieve().bodyToMono(Result.class).block();
    }

    @PutMapping(value = "/update")
    @Operation(summary = "修改", description = "修改支付流水")
    public Result updatePay(@RequestBody PayDTO payDTO) {
        String url = PAYMENT_SERVICE_URL + "/pay/update";
        return webClientBuilder.build().put().uri(url).contentType(MediaType.APPLICATION_JSON).bodyValue(payDTO).retrieve().bodyToMono(Result.class).block();
    }
}
```



## 重启后再次访问成功

![image-20240328210250933](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403282106446.png)

# 主流注册中心异同点