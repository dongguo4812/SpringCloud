# OpenFeign简介

## OpenFeign是什么

Feign是一个**声明性web服务客户端**。它使编写web服务客户端变得更容易。使用Feign创建一个接口并对其进行注释。它具有可插入的注释支持，包括Feign注释和JAX-RS注释。Feign还支持可插拔编码器和解码器。Spring Cloud添加了对Spring MVC注释的支持，以及对使用Spring Web中默认使用的HttpMessageConverter的支持。Spring Cloud集成了Eureka、Spring Cloud CircuitBreaker以及Spring Cloud LoadBalancer，以便在使用Feign时提供负载平衡的http客户端。



![image-20240329162948021](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734118.png)

声明一点：内容中提及的feign统一使用的是OpenFeign，Feign已经被OpenFeign所替代

- **Feign**：早期Spring Cloud版本中使用的声明式HTTP客户端，用于简化RESTful Web Service客户端的编写。Feign的核心思想是，将HTTP请求映射成接口，通过调用接口方法的方式，发送HTTP请求。
- **OpenFeign**：在后续版本的Spring Cloud中，Feign被OpenFeign所替代。OpenFeign是Netflix Feign的一个开源分支，它提供了与Feign相似的功能，但在性能和功能上可能有所改进。Spring Cloud OpenFeign为Spring Boot应用程序提供了集成OpenFeign的自动配置。

## OpenFeign能干什么

前面在使用**SpringCloud LoadBalancer**+WebClient时，利用WebClient对http请求的封装处理形成了一套模版化的调用方法。

但是在实际开发中，由于对服务依赖的调用可能不止一处，往往一个接口会被多处调用，所以通常都会针对每个微服务自行封装一些客户端类来包装这些依赖服务的调用。所以，OpenFeign在此基础上做了进一步封装，由他来帮助我们定义和实现依赖服务接口的定义。在OpenFeign的实现下，我们只需创建一个接口并使用注解的方式来配置它(在一个微服务接口上面标注一个**@FeignClient**注解即可)，即可完成对服务提供方的接口绑定，统一对外暴露可以被调用的接口方法，大大简化和降低了调用客户端的开发量，也即由服务提供者给出调用接口清单，消费者直接通过OpenFeign调用即可。

 

OpenFeign同时还集成SpringCloud LoadBalancer

可以在使用OpenFeign时提供Http客户端的负载均衡，也可以集成阿里巴巴Sentinel来提供熔断、降级等功能。而与SpringCloud LoadBalancer不同的是，通过OpenFeign只需要定义服务绑定接口且以声明式的方法，优雅而简单的实现了服务调用。



# 微服务使用OpenFeign

## 如何使用OpenFeign

1.主启动添加@EnableFeignClients启用 Feign 客户端功能

2.创建一个Rest接口并在该接口上添加注解@FeignClient

![image-20240329163310460](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734602.png)

## 创建Module cloud-consumer-feign-order80

cloud-consumer-feign-order80 服务消费者

cloud-api-common 公共API模块

cloud-provider-payment8001/8082 服务提供者

![image-20240329164555552](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734827.png)

## pom

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>
    <parent>
        <groupId>com.dongguo</groupId>
        <artifactId>SpringCloud</artifactId>
        <version>0.0.1-SNAPSHOT</version>
    </parent>
    <groupId>com.dongguo</groupId>
    <artifactId>cloud-consumer-feign-order80</artifactId>
    <version>0.0.1-SNAPSHOT</version>
    <name>cloud-consumer-feign-order80</name>
    <description>cloud-consumer-feign-order80</description>
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>
    <dependencies>
        <!-- 引入自己定义的api通用包 -->
        <dependency>
            <groupId>com.dongguo</groupId>
            <artifactId>cloud-api-common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        <!--openfeign-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-openfeign</artifactId>
        </dependency>
        <!--SpringCloud consul discovery-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-consul-discovery</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--fastjson2-->
        <dependency>
            <groupId>com.alibaba.fastjson2</groupId>
            <artifactId>fastjson2</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
        </dependency>
    </dependencies>

    <build>
        <plugins>
            <plugin>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-maven-plugin</artifactId>
            </plugin>
        </plugins>
    </build>

</project>
```

## yml

```yaml
server:
  port: 80

spring:
  application:
    name: cloud-consumer-openfeign-order
  ####Spring Cloud Consul for Service Discovery
  cloud:
    consul:
      host: localhost
      port: 8500
      discovery:
        prefer-ip-address: true #优先使用服务ip进行注册
        service-name: ${spring.application.name}
  # ========================日期格式化=====================
  jackson:
    date-format: yyyy-MM-dd HH:mm:ss
    time-zone: GMT-8
# ========================swagger=====================
springdoc:
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
```

## 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
import org.springframework.cloud.openfeign.EnableFeignClients;

@SpringBootApplication
@EnableDiscoveryClient //该注解用于向注册中心注册服务
@EnableFeignClients//启用feign客户端,定义服务+绑定接口，以声明式的方法优雅而简单的实现服务调用
public class FeignOrder80Application {

    public static void main(String[] args) {
        SpringApplication.run(FeignOrder80Application.class, args);
        System.out.println("http://127.0.0.1:80/swagger-ui.html");
    }

}
```

## 业务类

### 修改cloud-api-commons通用模块

1.引入openfeign依赖

```xml
<!--openfeign-->
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

2.新建服务接口PayFeignApi,并配置@FeignClient注解

参考微服务8001的Controller层，完成接口方法

```java
import com.dongguo.cloud.entity.DTO.PayDTO;
import com.dongguo.cloud.resp.Result;
import org.springframework.cloud.openfeign.FeignClient;
import org.springframework.web.bind.annotation.*;

@FeignClient(value = "cloud-payment-service")
public interface PayFeignApi {
    /**
     * 新增一条支付相关流水记录
     *
     * @param payDTO
     * @return
     */
    @PostMapping("/pay/add")
    Result addPay(@RequestBody PayDTO payDTO);

    /**
     * 按照主键记录查询支付流水信息
     *
     * @param id
     * @return
     */
    @GetMapping("/pay/get/{id}")
    Result getById(@PathVariable("id") Integer id);

    /**
     * 按照主键记录删除支付流水信息
     *
     * @param id
     * @return
     */
    @DeleteMapping("/pay/del/{id}")
    Result deletePay(@PathVariable("id") Integer id);

    /**
     * 修改支付流水
     * @param payDTO
     * @return
     */
    @PutMapping("/pay/update")
    Result updatePay(@RequestBody PayDTO payDTO);
    /**
     * openfeign天然支持负载均衡演示
     *
     * @return
     */
    @GetMapping(value = "/pay/get/info")
    Result getInfoByConsul();
}
```

3.重新clean、install cloud-api-commons

### cloud-consumer-feign-order80 创建OrderController

```java
@RestController
@Tag(name = "订单模块", description = "订单控制器接口")
public class OrderController {
    @Resource
    private PayFeignApi payFeignApi;

    @PostMapping("/feign/pay/add")
    @Operation(summary = "新增", description = "新增支付流水,json串做参数")
    public Result addOrder(@RequestBody PayDTO payDTO) {
        System.out.println("第一步：模拟本地addOrder新增订单成功(省略sql操作)，第二步：再开启addPay支付微服务远程调用");
        return payFeignApi.addPay(payDTO);
    }

    @GetMapping("/feign/pay/get/{id}")
    @Operation(summary = "按照ID查流水", description = "查询支付流水")
    public Result getPayInfo(@PathVariable("id") Integer id) {
        System.out.println("-------支付微服务远程调用，按照id查询订单支付流水信息");
        return payFeignApi.getById(id);
    }

    @DeleteMapping("/feign/pay/del/{id}")
    @Operation(summary = "删除", description = "删除支付流水")
    public Result deletePay(@PathVariable("id") Integer id) {
        return payFeignApi.getById(id);
    }

    @PutMapping("/feign/pay/update")
    @Operation(summary = "修改", description = "修改支付流水")
    public Result updatePay(@RequestBody PayDTO payDTO) {
        return payFeignApi.updatePay(payDTO);
    }

    /**
     * openfeign天然支持负载均衡演示
     *
     * @return
     */
    @GetMapping(value = "/feign/pay/get/info")
    @Operation(summary = "验证负载均衡")
    public Result getInfoByConsul() {
        return payFeignApi.getInfoByConsul();
    }
}
```

## 测试

启动8001、8002和feign80

![image-20240329173008945](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734023.png)

查询

![image-20240329173126395](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734442.png)

验证负载均衡

![image-20240329173211662](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734854.png)

![image-20240329173306012](https://gitee.com/dongguo4812_admin/image/raw/master/image/202403291734131.png)
