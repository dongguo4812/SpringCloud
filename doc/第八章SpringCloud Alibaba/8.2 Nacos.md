Nacos简介

![image-20240403141052375](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623571.png)

## 为什么叫Nacos

![image-20240403141224840](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623298.png)

前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service。

Nacos官网https://nacos.io/

一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台

![image-20240403141358354](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623314.png)

简单说Nacos就是注册中心+配置中心的组合。

替代Eureka/Consul做服务注册中心

替代（Config+Bus）/Consul做服务配置中心和动态刷新

# Nacos下载

https://nacos.io/docs/latest/quickstart/quick-start/

![image-20240403142257812](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623788.png)

当前最新版本为2.3.1

![image-20240403142622259](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623936.png)

点击下载

![image-20240403142844806](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623504.png)

1.解压安装包，直接运行bin目录下的startup.cmd

![image-20240403144856870](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622225.png)

```shell
startup.cmd -m standalone
```

![image-20240403144952086](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622508.png)

2.访问http://localhost:8848/nacos

![image-20240403145144463](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622669.png)

## 3.关闭服务

Ctrl+c或使用命令shutdown.cmd

![image-20240403145543061](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622879.png)

# Nacos Discovery服务注册中心

https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery#spring-cloud-alibaba-nacos-discovery

通过自动配置以及其他 Spring 编程模型的习惯用法为 Spring Boot 应用程序在服务注册与发现方面提供和 Nacos 的无缝集成。 通过一些简单的注解，您可以快速来注册一个服务，并使用经过双十一考验的 Nacos 组件来作为大规模分布式系统的服务注册中心。

## 服务注册发现: Nacos Discovery Starter

服务发现是微服务架构体系中最关键的组件之一。如果尝试着用手动的方式来给每一个客户端来配置所有服务提供者的服务列表是一件非常困难的事，而且也不利于 服务的动态扩缩容。Nacos Discovery Starter 可以帮助您将服务自动注册到 Nacos 服务端并且能够动态感知和刷新某个服务实例的服务列表。除此之外，Nacos Discovery Starter 也将服务实例自身的一些元数据信息-例如 host，port,健康检查URL，主页等-注册到 Nacos 。Nacos 的获取和启动方式可以参考 [Nacos 官网](https://nacos.io/zh-cn/docs/quick-start.html)。

#### 如何引入 Nacos Discovery Starter

如果要在您的项目中使用 Nacos 来实现服务发现，使用 group ID 为 `com.alibaba.cloud` 和 artifact ID 为 `spring-cloud-starter-alibaba-nacos-discovery` 的 starter。

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

## 基于Nacos的服务提供者

### 新建Module

cloud-alibaba-provider-payment9001

### pom

```xml
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>



    <dependencies>
        <!--nacos-discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!-- 引入自己定义的api通用包 -->
        <dependency>
            <groupId>com.dongguo</groupId>
            <artifactId>cloud-api-common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        <!--SpringBoot通用依赖模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--hutool-->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <scope>provided</scope>
        </dependency>
        <!--test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
```



### yml

```yaml
server:
  port: 9001

spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #配置Nacos地址
```

### 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Payment9001Application {

    public static void main(String[] args) {
        SpringApplication.run(Payment9001Application.class, args);
    }

}
```

### 业务类

创建PayAlibabaController

```java
import com.dongguo.cloud.resp.Result;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class PayAlibabaController {
    @Value("${server.port}")
    private String serverPort;

    @GetMapping(value = "/pay/nacos/{id}")
    public Result getPayInfo(@PathVariable("id") Integer id) {
        return Result.success("nacos registry, serverPort: " + serverPort + "\t id:" + id);
    }
}
```

### 测试

1.启动nacos

2.启动cloud-alibaba-provider-payment9001服务,查看服务是否注册到nacos

![image-20240403162030861](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622183.png)

3.访问http://localhost:9001/pay/nacos/1

![image-20240403161942248](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026867.png)

## 基于Nacos的服务消费者

### 新建Module

cloud-alibaba-consumer-order90

### pom

```xml
    <dependencies>
        <!--nacos-discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--loadbalancer-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
        <!--web + actuator-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
    </dependencies>
```



### yml

```yaml
server:
  port: 90
spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
#消费者将要去访问的微服务名称(nacos微服务提供者叫什么你写什么)
service-url:
  nacos-user-service: http://nacos-payment-provider
```

### 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Order90Application {

    public static void main(String[] args) {
        SpringApplication.run(Order90Application.class, args);
    }

}
```

### 业务类

WebClient远程服务调用WebClientConfig配置类

```java
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.loadbalancer.annotation.LoadBalancerClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
@LoadBalancerClient(
        //下面的value值大小写一定要和Nacos里面的名字一样，必须一样
        value = "nacos-payment-provider")
public class WebClientConfig {
    @Bean
    @LoadBalanced
    public WebClient.Builder loadBalancedWebClientBuilder() {
        return WebClient.builder();
    }
}
```



新建OrderNacosController

```java
import com.dongguo.cloud.resp.Result;
import jakarta.annotation.Resource;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.reactive.function.client.WebClient;

@RestController
public class OrderNacosController {
    @Resource
    private WebClient.Builder webClientBuilder;

    @Value("${service-url.nacos-user-service}")
    private String serverURL;

    @GetMapping("/consumer/pay/nacos/{id}")
    public Result paymentInfo(@PathVariable("id") Integer id) {
        String url = serverURL + "/pay/nacos/" + id;
        return webClientBuilder.build().get().uri(url).retrieve().bodyToMono(Result.class).block();
    }
}
```

### 测试

1.启动cloud-alibaba-consumer-order90服务,查看服务是否注册到nacos

![image-20240403172141456](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026900.png)

2.访问http://localhost:90/consumer/pay/nacos/1

![image-20240403172407476](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026976.png)

## 负载均衡



![image-20240403173132699](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026208.png)

启动9002

![image-20240403172858341](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026373.png)



![image-20240403173332789](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026662.png)

测试

@LoadBalanced是可以实现负载均衡的

![image-20240403173347958](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026695.png)



![image-20240403173356193](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026046.png)

# Nacos Config服务配置中心

https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config

Nacos 提供用于存储配置和其他元数据的 key/value 存储，为分布式系统中的外部化配置提供服务器端和客户端支持。使用 Spring Cloud Alibaba Nacos Config，您可以在 Nacos Server 集中管理你 Spring Cloud 应用的外部属性配置。

Spring Cloud Alibaba Nacos Config 是 Config Server 和 Client 的替代方案，客户端和服务器上的概念与 Spring Environment 和 PropertySource 有着一致的抽象，在特殊的 bootstrap 阶段，配置被加载到 Spring 环境中。当应用程序从开发到测试再到生产时，您可以管理这些环境之间的配置，并确保应用程序具有迁移时需要运行的所有内容。

## Nacos作为配置中心配置

通过Nacos和spring-cloud-starter-alibaba-nacos-config实现中心化全局配置的动态变更

### 创建Module

cloud-alibaba-config-client3377

### pom

```java
<dependencies>
    <!--nacos-config-->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
    </dependency>
    <!--nacos-discovery-->
    <dependency>
        <groupId>com.alibaba.cloud</groupId>
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
    </dependency>
    <!--web + actuator-->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-actuator</artifactId>
    </dependency>
    <!--lombok-->
    <dependency>
        <groupId>org.projectlombok</groupId>
        <artifactId>lombok</artifactId>
        <optional>true</optional>
    </dependency>
</dependencies>
```

### yml

https://developer.aliyun.com/article/897341

https://github.com/alibaba/spring-cloud-alibaba/pull/2349

![image-20240403215330628](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058571.png)

依然使用application.yml进行配置

```yaml
server:
  port: 3377

spring:
  application:
    name: nacos-config-client
  profiles:
    active: dev # 表示开发环境
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #Nacos服务注册中心地址
      config:
        server-addr: localhost:8848 #Nacos作为配置中心地址
        file-extension: yaml #指定yaml格式的配置
        group: DEFAULT_GROUP

  config:
    import:
#      - optional:nacos:nacos-config-client-dev.yaml  #关键点 导入外部配置源，读取Nacos中的配置
      - optional:nacos:${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}
```



### 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class ConfigClient3377Application {

    public static void main(String[] args) {
        SpringApplication.run(ConfigClient3377Application.class, args);
    }

}
```

### 业务类

```java
import com.dongguo.cloud.resp.Result;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RefreshScope //在控制器类加入@RefreshScope注解使当前类下的配置支持Nacos的动态刷新功能。
public class NacosConfigClientController {
    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/config/info")
    public Result getConfigInfo() {
        return Result.success(configInfo);
    }
}
```



### 基于 dataId 为 yaml 的文件扩展名配置方式

nacos端配置文件DataId的命名规则是：

${spring.application.name}-${spring.profile.active}.${spring.cloud.nacos.config.file-extension}

本案例的DataID是:nacos-config-client-dev.yaml

![image-20240403204740799](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058147.png)

1.创建Nacos配置

![image-20240403204901891](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058266.png)

2.填入配置

![image-20240403205052032](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058826.png)

### 测试

1.查看3377是否注册到Nacos

![image-20240404064818680](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058562.png)

2.访问http://localhost:3377/config/info

![image-20240404064838506](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058631.png)

## 自动刷新功能

在Spring Cloud体系的项目中，配置中心主要用于提供分布式的配置管理，其中有一个重要的注解：@RefreshScope,如果代码中需要动态刷新配置，在需要的类上加上该注解就行。



1.编辑Nacos配置列表中的nacos-config-client-dev.yaml，version=2

![image-20240404065030200](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058314.png)

2.访问http://localhost:3377/config/info，没有实现刷新功能

![image-20240404065208709](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058090.png)



3.发现控制台中，nacos监视到Refresh keys changed: []

```shell
2024-04-04T06:50:27.992+08:00  INFO 12272 --- [nacos-config-client] [ternal.notifier] o.s.c.e.event.RefreshEventListener       : Refresh keys changed: []
2024-04-04T06:50:27.992+08:00  INFO 12272 --- [nacos-config-client] [ternal.notifier] c.a.nacos.client.config.impl.CacheData   : [fixed-127.0.0.1_8848] [notify-ok] dataId=nacos-config-client-dev.yaml, group=DEFAULT_GROUP, md5=e90faab72b92ea49d7a79765cfc7cbd7, listener=com.alibaba.cloud.nacos.refresh.NacosContextRefresher$1@5bcbe085 ,cost=411 millis.
```





https://nacos.io/zh-cn/docs/quick-start-spring-cloud.html官网中给出使用@RefreshScope实现配置自动更新，但是我已经在NacosConfigClientController中加入了@RefreshScope

![image-20240404074147729](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058331.png)

### 查看解决方案1（无效）

原因：@RefreshScope注解的proxyMode默认值是ScopedProxyMode.TARGET_CLASS,也就是说代理模式使用的是CGLIB方式。如果@RefreshScope使用在@Controller或其他会被spring使用CGLIB代理的类上就会出问题。原因是@RefreshScope默认使用CGLIB代理，而目标类又是被CGLIB代理过的，这样就被代理了两次，第二次也就是@RefreshScope代理的时候会出现属性丢失的问题

解决方案：将注解改成@RefreshScope(proxyMode = ScopedProxyMode.DEFAULT)

```java
import com.dongguo.cloud.resp.Result;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.context.annotation.ScopedProxyMode;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
//@RefreshScope //在控制器类加入@RefreshScope注解使当前类下的配置支持Nacos的动态刷新功能。
@RefreshScope(proxyMode = ScopedProxyMode.DEFAULT)
public class NacosConfigClientController {
    @Value("${config.info}")
    private String configInfo;

    @GetMapping("/config/info")
    public Result getConfigInfo() {

        return Result.success(configInfo);
    }
}
```

结果：无效

### 查询解决方案2（有效）

https://github.com/alibaba/spring-cloud-alibaba/blob/2022.x/spring-cloud-alibaba-examples/nacos-example/nacos-config-example/src/main/resources/application.yaml

![image-20240404080720122](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058083.png)

配置改成optional:nacos:${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}?refresh=true测试是可以的

```yaml
      - optional:nacos:${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}?refresh=true
```

结果：有效

### 查询解决方案3（有效）

Nacos实现动态刷新配置的方法有两种：1、使用@RefreshScope，2、使用@ConfigurationProperties注解

改成方法2，使用@ConfigurationProperties注解可以将 Nacos 配置直接注入到 Java 对象的属性中，并实现配置的自动刷新

```java
import lombok.Data;
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.cloud.context.config.annotation.RefreshScope;
import org.springframework.stereotype.Component;


@RefreshScope
@ConfigurationProperties(prefix = "config")
@Component
@Data
public class Config {
    private String info;
}
```



```java
import com.dongguo.cloud.entity.Config;
import com.dongguo.cloud.resp.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RestController;
@RestController
public class NacosConfigClientController {

    @Autowired
    private Config config;

    @GetMapping("/config/info")
    public Result getConfigInfo() {
        return Result.success(config.getInfo());
    }
}
```

结果：有效

1.访问http://localhost:3377/config/info

![image-20240404074911852](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058947.png)

2.修改配置version=4

![image-20240404074933082](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058359.png)

3.控制台也打印出Nacos监控到配置的变化信息

![image-20240404075014570](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058585.png)

4.再次访问http://localhost:3377/config/info，已经是最新信息

![image-20240404075033525](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041058059.png)

## 历史配置

Nacos会记录配置文件的历史版本默认保留30天，

![image-20240404082926962](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057666.png)

此外还有一键回滚功能，回滚操作将会触发配置更新

![image-20240404082941178](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057778.png)

# Nacos数据模型之Namespace-Group-Datald解析

问题1：

实际开发中，通常一个系统会准备

dev开发环境

test测试环境

prod生产环境。

如何保证指定环境启动时服务能正确读取到Nacos上相应环境的配置文件呢？

 

问题2：

一个大型分布式微服务系统会有很多微服务子项目，

每个微服务项目又都会有相应的开发环境、测试环境、预发环境、正式环境......

那怎么对这些微服务配置进行分组和命名空间管理呢？



## 数据模型

Nacos 数据模型 Key 由三元组唯一确定, Namespace默认是空串，公共命名空间（public），分组默认是 DEFAULT_GROUP。

![nacos_data_model](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057113.jpeg)

1. **命名空间**：类似Java里面的package名和类名，最外层的Namespace是可以用于区分部署环境的。不仅适用于Nacos的配置管理，也适用于服务发现。其常用场景之一是不同环境的配置的区分隔离，例如开发测试环境和生产环境的资源（如配置、服务）隔离等。

   ![image-20240404090210110](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057656.png)

2. 配置分组：对配置集进行分组的概念，它可以帮助用户更好地管理和控制多个配置实例。在创建配置时，如果未明确指定配置分组的名称，则默认使用`DEFAULT_GROUP`。配置分组的一个常见场景是用于区分不同的项目或应用。

3. 服务实例：一个Service可以包含一个或者多个Cluster（集群），Nacos默认Cluster是DEFAULT，Cluster是对指定微服务的一个虚拟划分。见下面的服务领域模型



![image-20240404090245278](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057323.png)

默认情况：Namespace=public，Group=DEFAULT_GROUP。

Nacos默认的命名空间是public，Namespace主要用来实现隔离。比方说我们现在有三个环境：开发、测试、生产环境，我们就可以创建三个Namespace，不同的Namespace之间是隔离的。Group默认是DEFAULT_GROUP，Group可以把不同的微服务划分到同一个分组里面去

## 服务领域模型

Nacos将服务分为了三个级别：服务、集群和实例。一个服务可以包含多个集群，而一个集群又可以包含多个实例。这种分级存储的方式有助于更细致地管理和控制服务。

![nacos_naming_data_model](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057267.jpeg)

## DataID方案

指定spring.profile.active和配置文件的DatalD来使不同环境下读取不同的配置,只配置DataId：默认空间public+默认分组DEFAULT_GROUP+新建的DatalD

1、在应用的 application.yml配置文件中显示的声明 dataId 文件扩展名。

 dataId 文件扩展名在此之前已经配置

```yaml
spring:
  application:
    name: nacos-config-client
  profiles:
    active: dev # 表示开发环境
  cloud:
    nacos:
      config:
        server-addr: localhost:8848 #Nacos作为配置中心地址
        file-extension: yaml #指定yaml格式的配置
```

2.在 Nacos 的控制台新增一个dataId为yaml为扩展名的配置，如下所示：

![image-20240404103227043](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057728.png)

3.激活测试环境

```yaml
spring:
  profiles:
    active: test
```

4.测试，访问http://localhost:3377/config/info，读取nacos-config-client-test.yaml配置

![image-20240404103449584](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057459.png)

## Group方案

通过Group实现环境区分，配置DataId和Group：默认空间public+新建的PROD_GROUP+新建的DatalD

在没有明确指定 `${spring.cloud.nacos.config.group}` 配置的情况下， 默认使用的是 DEFAULT_GROUP 。如果需要自定义自己的 Group，可以通过以下配置来实现：

```yaml
spring:
  cloud:
    nacos:
      config:
        server-addr: localhost:8848 #Nacos作为配置中心地址
        file-extension: yaml #指定yaml格式的配置
        group: PROD_GROUP
```

1.新建prod配置DataID：nacos-config-client-prod.yaml、Group：PROD_GROUP

![image-20240404104145256](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057021.png)

2.修改yml

```yaml
spring:
  profiles:
    active: prod
```

3.测试

![image-20240404104254053](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057790.png)

## Namespace方案

通过Namespace实现命名空间环境区分

1.新建namespace：prod

![image-20240404104843075](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057851.png)

自动生成的命名空间ID

![image-20240404104908907](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057034.png)

2.配置列表，选中prod命名空间

![image-20240404104625433](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057947.png)

3.创建DataId：nacos-config-client-prod.yaml、Group：PROD_GROUP 配置

![image-20240404105157629](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057763.png)

4.修改yml

```yml
server:
  port: 3377

spring:
  application:
    name: nacos-config-client
  profiles:
    active: prod #激活环境
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #Nacos服务注册中心地址
      config:
        server-addr: localhost:8848 #Nacos作为配置中心地址
        file-extension: yaml #指定yaml格式的配置
        group: PROD_GROUP
        namespace: 47d25579-1b10-4503-8bff-1a1794b629b6
  config:
    import:
      - optional:nacos:${spring.application.name}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}?refresh=true
```

5.测试

![image-20240404105631147](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404041057300.png)

