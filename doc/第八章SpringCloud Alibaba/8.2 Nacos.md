# Nacos简介

![image-20240403141052375](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623571.png)

## 为什么叫Nacos

![image-20240403141224840](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623298.png)

前四个字母分别为Naming和Configuration的前两个字母，最后的s为Service。

Nacos官网https://nacos.io/

一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台

![image-20240403141358354](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623314.png)

简单说Nacos就是注册中心+配置中心的组合。

替代Eureka/Consul做服务注册中心

替代（Config+Bus）/Consul做服务配置中心和动态刷新

# Nacos下载

https://nacos.io/docs/latest/quickstart/quick-start/

![image-20240403142257812](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623788.png)

当前最新版本为2.3.1

![image-20240403142622259](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623936.png)

点击下载

![image-20240403142844806](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031623504.png)

1.解压安装包，直接运行bin目录下的startup.cmd

![image-20240403144856870](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622225.png)

```shell
startup.cmd -m standalone
```

![image-20240403144952086](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622508.png)

2.访问http://localhost:8848/nacos

![image-20240403145144463](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622669.png)

## 3.关闭服务

Ctrl+c或使用命令shutdown.cmd

![image-20240403145543061](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622879.png)

# Nacos Discovery服务注册中心

https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery#spring-cloud-alibaba-nacos-discovery

通过自动配置以及其他 Spring 编程模型的习惯用法为 Spring Boot 应用程序在服务注册与发现方面提供和 Nacos 的无缝集成。 通过一些简单的注解，您可以快速来注册一个服务，并使用经过双十一考验的 Nacos 组件来作为大规模分布式系统的服务注册中心。

## 服务注册发现: Nacos Discovery Starter

服务发现是微服务架构体系中最关键的组件之一。如果尝试着用手动的方式来给每一个客户端来配置所有服务提供者的服务列表是一件非常困难的事，而且也不利于 服务的动态扩缩容。Nacos Discovery Starter 可以帮助您将服务自动注册到 Nacos 服务端并且能够动态感知和刷新某个服务实例的服务列表。除此之外，Nacos Discovery Starter 也将服务实例自身的一些元数据信息-例如 host，port,健康检查URL，主页等-注册到 Nacos 。Nacos 的获取和启动方式可以参考 [Nacos 官网](https://nacos.io/zh-cn/docs/quick-start.html)。

#### 如何引入 Nacos Discovery Starter

如果要在您的项目中使用 Nacos 来实现服务发现，使用 group ID 为 `com.alibaba.cloud` 和 artifact ID 为 `spring-cloud-starter-alibaba-nacos-discovery` 的 starter。

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

## 基于Nacos的服务提供者

### 新建Module

cloudalibaba-provider-payment9001

### pom

```xml
    <properties>
        <maven.compiler.source>17</maven.compiler.source>
        <maven.compiler.target>17</maven.compiler.target>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    </properties>



    <dependencies>
        <!--nacos-discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!-- 引入自己定义的api通用包 -->
        <dependency>
            <groupId>com.dongguo</groupId>
            <artifactId>cloud-api-common</artifactId>
            <version>0.0.1-SNAPSHOT</version>
        </dependency>
        <!--SpringBoot通用依赖模块-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--hutool-->
        <dependency>
            <groupId>cn.hutool</groupId>
            <artifactId>hutool-all</artifactId>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <scope>provided</scope>
        </dependency>
        <!--test-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
    </dependencies>
```



### yml

```yaml
server:
  port: 9001

spring:
  application:
    name: nacos-payment-provider
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 #配置Nacos地址
```

### 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Payment9001Application {

    public static void main(String[] args) {
        SpringApplication.run(Payment9001Application.class, args);
    }

}
```

### 业务类

创建PayAlibabaController

```java
import com.dongguo.cloud.resp.Result;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;

@RestController
public class PayAlibabaController {
    @Value("${server.port}")
    private String serverPort;

    @GetMapping(value = "/pay/nacos/{id}")
    public Result getPayInfo(@PathVariable("id") Integer id) {
        return Result.success("nacos registry, serverPort: " + serverPort + "\t id:" + id);
    }
}
```

### 测试

1.启动nacos

2.启动cloudalibaba-provider-payment9001服务,查看服务是否注册到nacos

![image-20240403162030861](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404031622183.png)

3.访问http://localhost:9001/pay/nacos/1

![image-20240403161942248](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026867.png)

## 基于Nacos的服务消费者

### 新建Module

cloud-alibaba-consumer-order90

### pom

```xml
    <dependencies>
        <!--nacos-discovery-->
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
        </dependency>
        <!--loadbalancer-->
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-loadbalancer</artifactId>
        </dependency>
        <!--web + actuator-->
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-actuator</artifactId>
        </dependency>
        <!--lombok-->
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
            <optional>true</optional>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-webflux</artifactId>
        </dependency>
    </dependencies>
```



### yml

```yaml
server:
  port: 90
spring:
  application:
    name: nacos-order-consumer
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
#消费者将要去访问的微服务名称(nacos微服务提供者叫什么你写什么)
service-url:
  nacos-user-service: http://nacos-payment-provider
```

### 主启动

```java
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.client.discovery.EnableDiscoveryClient;

@SpringBootApplication
@EnableDiscoveryClient
public class Order90Application {

    public static void main(String[] args) {
        SpringApplication.run(Order90Application.class, args);
    }

}
```

### 业务类

WebClient远程服务调用WebClientConfig配置类

```java
import org.springframework.cloud.client.loadbalancer.LoadBalanced;
import org.springframework.cloud.loadbalancer.annotation.LoadBalancerClient;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.reactive.function.client.WebClient;

@Configuration
@LoadBalancerClient(
        //下面的value值大小写一定要和Nacos里面的名字一样，必须一样
        value = "nacos-payment-provider")
public class WebClientConfig {
    @Bean
    @LoadBalanced
    public WebClient.Builder loadBalancedWebClientBuilder() {
        return WebClient.builder();
    }
}
```



新建OrderNacosController

```java
import com.dongguo.cloud.resp.Result;
import jakarta.annotation.Resource;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.reactive.function.client.WebClient;

@RestController
public class OrderNacosController {
    @Resource
    private WebClient.Builder webClientBuilder;

    @Value("${service-url.nacos-user-service}")
    private String serverURL;

    @GetMapping("/consumer/pay/nacos/{id}")
    public Result paymentInfo(@PathVariable("id") Integer id) {
        String url = serverURL + "/pay/nacos/" + id;
        return webClientBuilder.build().get().uri(url).retrieve().bodyToMono(Result.class).block();
    }
}
```

### 测试

1.启动cloud-alibaba-consumer-order90服务,查看服务是否注册到nacos

![image-20240403172141456](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026900.png)

2.访问http://localhost:90/consumer/pay/nacos/1

![image-20240403172407476](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026976.png)

## 负载均衡



![image-20240403173132699](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026208.png)

启动9002

![image-20240403172858341](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026373.png)



![image-20240403173332789](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026662.png)

测试

@LoadBalanced是可以实现负载均衡的

![image-20240403173347958](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026695.png)



![image-20240403173356193](https://gitee.com/dongguo4812_admin/image/raw/master/image/202404032026046.png)

# Nacos Config服务配置中心

https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-config

Nacos 提供用于存储配置和其他元数据的 key/value 存储，为分布式系统中的外部化配置提供服务器端和客户端支持。使用 Spring Cloud Alibaba Nacos Config，您可以在 Nacos Server 集中管理你 Spring Cloud 应用的外部属性配置。

Spring Cloud Alibaba Nacos Config 是 Config Server 和 Client 的替代方案，客户端和服务器上的概念与 Spring Environment 和 PropertySource 有着一致的抽象，在特殊的 bootstrap 阶段，配置被加载到 Spring 环境中。当应用程序从开发到测试再到生产时，您可以管理这些环境之间的配置，并确保应用程序具有迁移时需要运行的所有内容。

## Nacos作为配置中心配置

通过Nacos和spring-cloud-starter-alibaba-nacos-config实现中心化全局配置的动态变更

### 创建Module

cloud-alibaba-config-client3377